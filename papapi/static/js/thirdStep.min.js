let db,dbVersion=1;var columnsFromCsv=Object.keys(JSON.parse(sessionStorage.getItem("csv"))[0]),dataToBackend={fields:{}},current=0;function close(){$("body").css("opacity","0"),setTimeout(function(){window.location.href="/result"},500)}function initDb(e){let t=indexedDB.open("diplomas",dbVersion);t.onerror=function(e){console.error("Unable to open database.")},t.onsuccess=function(t){db=t.target.result,console.log("db opened"),e()},t.onupgradeneeded=function(t){(db=t.target.result).createObjectStore("image",{keyPath:"timestamp"}),e()}}function loadImage(){let e=document.querySelector("#iimage"),t=db.transaction(["image"],"readonly").objectStore("image");t.openCursor(null,"prev").onsuccess=function(n){if(n.target.result){let o=n.target.result.value;t.get(o.timestamp).onsuccess=function(t){let n=t.target.result;dataToBackend.template=btoa(n.data),e.src="data:image/png;base64,"+btoa(n.data)}}}}function update1(e){dataToBackend.fields[columnsFromCsv[current]].font=e}function update2(e){dataToBackend.fields[columnsFromCsv[current]].size=e}function printMousePos(e){var t=e.target.getBoundingClientRect();console.log(t),console.log(e.clientX-t.left+"|"+(e.clientY-t.top)),"IMG"==e.target.tagName&&(current+2>columnsFromCsv.length?(document.getElementById("showpreview").removeAttribute("hidden"),document.getElementById("buttonnext").removeAttribute("hidden")):current+2<=columnsFromCsv.length&&(document.getElementById("nextcolumn").removeAttribute("hidden"),document.getElementById("showpreview").removeAttribute("hidden")),dataToBackend.fields[columnsFromCsv[current]].percentage=[(e.clientX-t.left)/t.width,(e.clientY-t.top)/t.height],dataToBackend.fields[columnsFromCsv[current]].size=document.getElementById("b").value)}function download_preview(){font=document.getElementById("a"),font_size=document.getElementById("b");var e=new XMLHttpRequest;e.onreadystatechange=function(){4==e.readyState&&200==e.status&&(js=JSON.parse(e.response),document.querySelector("#iimage").src="data:image/png;base64,"+js.image)},e.open("POST","/preview",!0),e.setRequestHeader("Content-type","application/json"),console.log(dataToBackend),e.send(JSON.stringify(dataToBackend))}function next(){(current+=1)+1>columnsFromCsv.length?document.getElementById("nextcolumn").setAttribute("hidden",!0):current+1<=columnsFromCsv.length&&(document.getElementById("nextcolumn").setAttribute("hidden",!0),document.getElementById("showpreview").setAttribute("hidden",!0)),document.getElementById("columnName").innerHTML=columnsFromCsv[current]}function prev(){current+2>columnsFromCsv.length?document.getElementById("nextcolumn").setAttribute("hidden",!0):current+2<=columnsFromCsv.length&&(document.getElementById("nextcolumn").setAttribute("hidden",!0),document.getElementById("showpreview").setAttribute("hidden",!0)),document.getElementById("columnName").innerHTML=columnsFromCsv[current+1],current+=1}function nextPage(){sessionStorage.setItem("dataToBackend",JSON.stringify(dataToBackend)),close()}document.addEventListener("DOMContentLoaded",()=>{for(let e of(dataToBackend.csv=JSON.parse(sessionStorage.getItem("csv")),columnsFromCsv))dataToBackend.fields[e]={font:"Ubuntu-L.ttf",size:16,color:255};document.getElementById("columnName").innerHTML=columnsFromCsv[current],initDb(loadImage),$("body").css("opacity","1")}),document.addEventListener("click",printMousePos);