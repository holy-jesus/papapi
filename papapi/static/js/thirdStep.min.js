var db,dbVersion=1,columnsFromCsv=Object.keys(JSON.parse(sessionStorage.getItem("csv"))[0]),dataToBackend={fields:{}},current=0;const delay=e=>new Promise(t=>setTimeout(t,e));function sendFont(e){var t=e.target.files[0],n=t.name,a=new FileReader;a.readAsBinaryString(t),a.onload=function(e){var t=btoa(e.target.result),a=new XMLHttpRequest;a.onreadystatechange=()=>{if(4==a.readyState&&200==a.status){var e=document.getElementById("a"),t=document.createElement("option");t.value=n,t.innerHTML=n,e.add(t),e.value=n}},a.open("POST","/font",!0),a.setRequestHeader("Content-type","application/json"),a.send(JSON.stringify({font:t,filename:n}))}}function close(){sessionStorage.setItem("step",4),db.close(),$("body").css("opacity","0"),setTimeout(function(){window.location.href="/result"},500)}function initDb(e){var t=indexedDB.open("diplomas",dbVersion);t.onerror=function(e){console.error("Unable to open database.")},t.onsuccess=function(t){db=t.target.result,console.log("db opened"),e()},t.onupgradeneeded=function(t){(db=t.target.result).createObjectStore("image",{keyPath:"timestamp"}),e()}}function loadImage(){var e=document.querySelector("#iimage"),t=db.transaction(["image"],"readonly").objectStore("image");t.openCursor(null,"prev").onsuccess=function(n){if(n.target.result){var a=n.target.result.value;t.get(a.timestamp).onsuccess=function(t){var n=t.target.result;dataToBackend.template=btoa(n.data),e.src="data:image/png;base64,"+btoa(n.data)}}}}function update1(e){dataToBackend.fields[columnsFromCsv[current]].font=e}function update2(e){dataToBackend.fields[columnsFromCsv[current]].size=e}function printMousePos(e){var t=e.target.getBoundingClientRect();"IMG"==e.target.tagName&&(current+2>columnsFromCsv.length?(document.getElementById("showpreview").removeAttribute("hidden"),document.getElementById("buttonnext").removeAttribute("hidden")):current+2<=columnsFromCsv.length&&(document.getElementById("nextcolumn").removeAttribute("hidden"),document.getElementById("showpreview").removeAttribute("hidden")),dataToBackend.fields[columnsFromCsv[current]].percentage=[(e.clientX-t.left)/t.width,(e.clientY-t.top)/t.height],dataToBackend.fields[columnsFromCsv[current]].size=document.getElementById("b").value,dataToBackend.fields[columnsFromCsv[current]].font=document.getElementById("a").value)}function download_preview(){font=document.getElementById("a"),font_size=document.getElementById("b");var e=new XMLHttpRequest;e.onreadystatechange=function(){4==e.readyState&&200==e.status&&(js=JSON.parse(e.response),document.querySelector("#iimage").src="data:image/png;base64,"+js.image)},e.open("POST","/preview",!0),e.setRequestHeader("Content-type","application/json"),e.send(JSON.stringify(dataToBackend))}function next(){(current+=1)+1>columnsFromCsv.length?document.getElementById("nextcolumn").setAttribute("hidden",!0):current+1<=columnsFromCsv.length&&(document.getElementById("nextcolumn").setAttribute("hidden",!0),document.getElementById("showpreview").setAttribute("hidden",!0)),document.getElementById("columnName").innerHTML=columnsFromCsv[current],dataToBackend.fields[columnsFromCsv[current]].size=document.getElementById("b").value,dataToBackend.fields[columnsFromCsv[current]].font=document.getElementById("a").value}function prev(){current+2>columnsFromCsv.length?document.getElementById("nextcolumn").setAttribute("hidden",!0):current+2<=columnsFromCsv.length&&(document.getElementById("nextcolumn").setAttribute("hidden",!0),document.getElementById("showpreview").setAttribute("hidden",!0)),document.getElementById("columnName").innerHTML=columnsFromCsv[current+1],current+=1}function loading(){gsap.timeline({repeat:-1}).to(".b1",{duration:.4,y:-25,ease:"power3",transformOrigin:"50% 50%"},0).to(".b1",{duration:.55,y:55,ease:"power2.inOut"},.35).to(".b1",{duration:.9,x:120,ease:"expo.inOut"},.4).to(".b1",{duration:.6,scale:.82,ease:"power3.in",yoyo:!0,repeat:1},.25).to(".b1",{duration:.4,y:0,ease:"back.out(6)"},.95).to(".b1",{duration:.4,rotation:-270,ease:"power1.in"},.9).to(".b",{duration:.9,x:-30,ease:"expo.inOut",stagger:.04},.3).to(".b",{duration:.45,rotation:5,stagger:.04,ease:"power3.in",transformOrigin:"60% 95%"},.3).to(".b",{duration:.4,rotation:0,stagger:.04,ease:"back.out(10)"},.85)}function sweapDisplay(){first=(get=document.querySelector.bind(document))("#main"),second=get("#loading"),first.style.opacity=0,setTimeout(function(){first.style.display="none",second.style.display="block"},500),loading(),second.style.opacity=1}async function getId(e){var t=new XMLHttpRequest;t.onreadystatechange=()=>{4==t.readyState&&200==t.status&&e(JSON.parse(t.responseText).id)},t.open("POST","/format",!0),t.setRequestHeader("Content-type","application/json"),t.send(JSON.stringify(dataToBackend))}async function checkIfReady(e){console.log(e);var t=new XMLHttpRequest,n=!1;for(t.onreadystatechange=()=>{4==t.readyState&&200==t.status&&(n=JSON.parse(t.responseText).done)};await delay(2e3),t.open("GET","/status?id="+e,!0),t.send(null),!n;);sessionStorage.setItem("id",e),close()}async function nextPage(){sweapDisplay(),getId(checkIfReady)}document.addEventListener("DOMContentLoaded",()=>{for(let e of(document.querySelector("#font").addEventListener("change",sendFont),dataToBackend.csv=JSON.parse(sessionStorage.getItem("csv")),columnsFromCsv))dataToBackend.fields[e]={font:"Arimo-Regular.ttf",size:16,color:255};document.getElementById("columnName").innerHTML=columnsFromCsv[current],initDb(loadImage),$("body").css("opacity","1")}),document.addEventListener("click",printMousePos);